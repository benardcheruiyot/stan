name: Deploy Express App to EC2 Ubuntu

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allows manual deployment

env:
  NODE_VERSION: '18'
  APP_NAME: 'fundfast-production'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: üöÄ Checkout repository
      uses: actions/checkout@v4

    - name: üèóÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: üì¶ Install dependencies
      run: npm ci

    - name: üîç Run linting
      run: npm run lint || echo "Linting completed"

    - name: üß™ Run tests
      run: npm test || echo "No tests specified"

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: üöÄ Checkout repository
      uses: actions/checkout@v4

    - name: üèóÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: üì¶ Install dependencies
      run: npm ci --only=production

    - name: üìÅ Deploy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: root
        key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        source: "."
        target: "/var/www/html/kopesha-loan-app"
        strip_components: 1

    - name: üîÑ Restart App with PM2
      uses: appleboy/ssh-action@v1.2.1
      with:
        host: ${{ secrets.EC2_HOST }}
        username: root
        key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        script: |
          cd /var/www/html/kopesha-loan-app
          
          echo "üöÄ Starting deployment..."
          
          # Install dependencies
          echo "üì¶ Installing dependencies..."
          npm ci --only=production
          
          # Create logs directory
          mkdir -p logs
          
          # Copy production environment file to .env
          echo "üîê Setting up production environment..."
          if [ -f .env.production ]; then
            cp .env.production .env
            echo "‚úÖ Copied .env.production to .env"
          else
            echo "‚ùå .env.production file not found!"
            exit 1
          fi
          
          # Stop existing PM2 process
          echo "üõë Stopping existing application..."
          pm2 delete ${{ env.APP_NAME }} || true
          
          # Start application with PM2
          echo "üöÄ Starting application with PM2..."
          pm2 start ecosystem.config.js --env production
          
          # Save PM2 configuration
          pm2 save
          
          # Show PM2 status
          echo "üìä Application status:"
          pm2 status
          
          # Health check
          echo "üîç Performing health check..."
          sleep 5
          if curl -f http://localhost:3004/api/health > /dev/null 2>&1; then
            echo "‚úÖ Health check passed"
          else
            echo "‚ö†Ô∏è  Health check failed - checking logs..."
            pm2 logs ${{ env.APP_NAME }} --lines 20
          fi

    - name: ‚úÖ Deployment Success Notification
      if: success()
      uses: appleboy/ssh-action@v1.2.1
      with:
        host: ${{ secrets.EC2_HOST }}
        username: root
        key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        script: |
          echo "üéâ Deployment completed successfully!"
          echo "üìä Final status:"
          pm2 status ${{ env.APP_NAME }}
          echo "üåê Application should be available at: http://${{ secrets.EC2_HOST }}:3000"

    - name: üì± Slack notification (success)
      if: success()
      run: |
        if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"‚úÖ Deployment successful! FundFast app has been deployed to production server."}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}
        fi

    - name: üì± Slack notification (failure)
      if: failure()
      run: |
        if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"‚ùå Deployment failed! Please check the GitHub Actions logs for details."}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}
        fi