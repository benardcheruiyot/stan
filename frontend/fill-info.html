<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fill Required Information</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/theme-merged.css" rel="stylesheet">
</head>
<body>
    <div class="container" style="padding: 40px 0;">
        <div class="card p-4" style="background:rgba(255,255,255,0.85);border-radius:16px;box-shadow:0 10px 40px rgba(100,125,222,0.10);">
            <h2 style="color:#647dee;">Please complete your information</h2>
            <p style="color: rgba(255,255,255,0.8);">Fill the missing or incorrect fields below to continue checking eligibility.</p>

            <form id="fillForm">
                <div class="mb-3">
                    <label class="form-label">First Name *</label>
                    <input id="firstName" class="form-control" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Last Name *</label>
                    <input id="lastName" class="form-control" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Phone (254712345678)</label>
                    <input id="phoneNumber" class="form-control" />
                </div>
                <div class="mb-3">
                    <label class="form-label">ID Number</label>
                    <input id="idNumber" class="form-control" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Date of Birth</label>
                    <input id="dateOfBirth" type="date" class="form-control" />
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Save & Check Eligibility</button>
                    <a href="index.html" class="btn btn-outline-light">Cancel</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        function validatePhoneNumber(phone) {
            phone = (phone || '').replace(/[\s\-\+]/g, '');
            if (phone.startsWith('254') && phone.length === 12) return phone;
            if (phone.startsWith('07') && phone.length === 10) return '254' + phone.substring(1);
            if (phone.startsWith('7') && phone.length === 9) return '254' + phone;
            return null;
        }

        // Prefill fields from query params
        (function prefill(){
            const params = new URLSearchParams(window.location.search);
            const fields = ['firstName','lastName','phone','idNum','dob','missing'];
            for (const f of fields) {
                if (params.has(f)) {
                    const el = document.getElementById(f === 'phone' ? 'phoneNumber' : (f === 'idNum' ? 'idNumber' : (f === 'dob' ? 'dateOfBirth' : f)));
                    if (el) el.value = params.get(f);
                }
            }
            // Focus first missing if provided
            if (params.has('missing')) {
                const missing = params.get('missing').split(',')[0];
                const map = { firstName: 'firstName', lastName: 'lastName', phone: 'phoneNumber', idNum: 'idNumber', dob: 'dateOfBirth' };
                const el = document.getElementById(map[missing]);
                if (el) el.focus();
            }
        })();

        document.getElementById('fillForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const phoneRaw = document.getElementById('phoneNumber').value.trim();
            const phone = validatePhoneNumber(phoneRaw);
            const idNum = document.getElementById('idNumber').value.trim();
            const dob = document.getElementById('dateOfBirth').value;

            if (!firstName || !lastName || !phone || !/^[0-9]{1,8}$/.test(idNum) || !dob) {
                alert('Please fill all fields correctly.');
                return;
            }

            // Call backend eligibility API
            fetch('/api/check-eligibility', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ firstName, lastName, phone: phoneRaw, idNum, dob })
            }).then(r => r.json()).then(json => {
                if (!json || !json.success) {
                    alert('Eligibility service error. Please try again later.');
                    return;
                }
                if (json.eligible) {
                    // proceed to application page
                    window.location.href = 'apply.html';
                } else {
                    alert('Not eligible: ' + (json.reason || 'You do not meet pre-eligibility criteria'));
                }
            }).catch(err => {
                console.error('Eligibility API error', err);
                alert('Network error. Please try again later.');
            });
        });
    </script>
</body>
</html>
